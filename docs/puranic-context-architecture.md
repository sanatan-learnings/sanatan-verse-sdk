# Puranic Context Architecture

## Overview

The puranic context system allows the SDK to generate structured Puranic reference boxes
for verse files, grounded in actual source texts (PDFs, TXT files) rather than relying
solely on GPT-4's free recall.

## Directory Structure

```
data/
  puranic-references.yml          # registry of indexed sources
  sources/
    valmiki-ramayana.pdf          # source of truth (Git LFS for PDFs)
    skanda-purana.txt             # or plain text / markdown
  puranic-index/
    valmiki-ramayana.yml          # generated by indexing, then human-owned
    skanda-purana.yml
  embeddings/
    valmiki-ramayana.json         # versioned in git
    skanda-purana.json
    hanuman-chalisa.json          # verse embeddings (also versioned, not gitignored)
```

## `data/puranic-references.yml`

Written by `verse-index-sources` on successful indexing. Never manually created.

```yaml
valmiki-ramayana:
  enabled: true
  name: Valmiki Ramayana
  format: pdf                     # pdf | txt | md

skanda-purana:
  enabled: true
  name: Skanda Purana
  format: txt

hanuman-chalisa-commentary:
  enabled: false                  # indexed but not active yet
  name: Hanuman Chalisa Commentary
  format: pdf
```

File paths are fully predictable from the key and format:
- Source: `data/sources/<key>.<format>`
- Index:  `data/puranic-index/<key>.yml`
- Embeddings: `data/embeddings/<key>.json`

## `data/puranic-index/valmiki-ramayana.yml`

Generated once by `verse-index-sources`, then treated as human-owned (can be
hand-edited to correct AI errors).

```yaml
episodes:
  - id: sun-swallowing-episode
    type: story                   # story | concept | character | etymology | practice | cross_reference
    keywords: [hanuman, surya, childhood, bala-kanda]
    source:
      book: Bala Kanda
      sarga: 16
    summary_en: "Hanuman as a child mistook the sun for a ripe fruit..."
    summary_hi: "बाल हनुमान ने सूर्य को पके फल समझकर..."

  - id: hanuman-birth-episode
    type: character
    keywords: [hanuman, birth, anjana, vayu]
    source:
      book: Bala Kanda
      sarga: 15
    summary_en: "..."
    summary_hi: "..."
```

## Git Strategy

**`.gitattributes`** — PDFs tracked via Git LFS:
```
data/sources/*.pdf filter=lfs diff=lfs merge=lfs -text
```

**Nothing gitignored under `data/`** — all three artifacts (source, index, embeddings)
are versioned. Rationale:
- Sources are immutable reference texts
- Index is expensive to regenerate and may be hand-curated
- Embeddings are expensive to regenerate (API calls)

## Embeddings Provider

Sources contain Sanskrit/Hindi content — standard OpenAI embeddings are
English-optimised and perform poorly on Indic languages.

**Required first: Issue #1 — Bedrock Cohere multilingual embeddings**
- Cohere `embed-multilingual-v3` supports 100+ languages including Sanskrit, Hindi,
  Tamil, Bengali, Marathi
- 1024 dimensions vs OpenAI's 1536 (33% smaller)
- IAM authentication (no API keys)
- Same model used for both verse embeddings and puranic index embeddings

Dependency order:
```
Issue #1: Bedrock Cohere embeddings   ← implement first
     ↓
verse-index-sources                   ← uses multilingual embeddings
     ↓
verse-puranic-context                 ← uses index + embeddings
```

## Commands

See the command reference docs for full usage:

- [`verse-index-sources`](commands/verse-index-sources.md) — index source texts into episodes + embeddings
- [`verse-puranic-context`](commands/verse-puranic-context.md) — generate `puranic_context` frontmatter entries

And the [README Puranic Context section](../README.md#puranic-context-generation) for the end-to-end workflow.

## `puranic_context` YAML Schema (in verse frontmatter)

```yaml
puranic_context:
  - id: sun-swallowing-episode
    type: story
    priority: high
    title:
      en: "The Sun-Swallowing Episode"
      hi: "सूर्य निगलने का प्रसंग"
    icon: ☀️
    story_summary:
      en: "..."
      hi: "..."
    theological_significance:
      en: "..."
      hi: "..."
    practical_application:
      en: "..."
      hi: "..."
    source_texts:
      - text: Valmiki Ramayana
        section: Bala Kanda, Sarga 16
    related_verses: []
```

## See Also

- [verse-embeddings](commands/verse-embeddings.md) — verse semantic search embeddings
- [verse-index-sources](commands/verse-index-sources.md) — full command reference
- [verse-puranic-context](commands/verse-puranic-context.md) — full command reference
